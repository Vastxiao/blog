<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Xiao&#39;s Notes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="渺小的个人博客.">
<meta property="og:type" content="website">
<meta property="og:title" content="Xiao's Notes">
<meta property="og:url" content="https://vastxiao.github.io/index.html">
<meta property="og:site_name" content="Xiao's Notes">
<meta property="og:description" content="渺小的个人博客.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Xiao's Notes">
<meta name="twitter:description" content="渺小的个人博客.">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://vastxiao.github.io"></form>
      </div>
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      
    </div>
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Xiao&#39;s Notes</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Vastxiao</a>
        </h2>
      
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-curator_install" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/elastic/curator_install/" class="article-date">
  <time datetime="2017-03-26T11:17:02.000Z" itemprop="datePublished">2017-03-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/elastic/">elastic</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/elastic/curator_install/">Elastic Curator 简介和安装</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h1 id="curator"><a href="#curator" class="headerlink" title="curator"></a>curator</h1><ul>
<li>curator是一个用于管理es中的索引和快照的工具。</li>
<li>curator是用Python写的，可以作为命令行工具，也能作为python的API。</li>
</ul>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/client/curator/current/index.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/client/curator/current/index.html</a></p>
<h2 id="Features"><a href="#Features" class="headerlink" title="Features"></a>Features</h2><ul>
<li>Add or remove indices (or both!) from an alias</li>
<li>Change shard routing allocation</li>
<li>Close indices</li>
<li>Create index</li>
<li>Delete indices</li>
<li>Delete snapshots</li>
<li>Open closed indices</li>
<li>forceMerge indices</li>
<li>Change the number of replicas per shard for indices</li>
<li>Take a snapshot (backup) of indices</li>
<li>Restore snapshots</li>
</ul>
<h2 id="Version-Compatibility"><a href="#Version-Compatibility" class="headerlink" title="Version Compatibility"></a>Version Compatibility</h2><p>curator对es版本的支持情况：</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/client/curator/current/version-compatibility.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/client/curator/current/version-compatibility.html</a></p>
<h2 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h2><p>从Curator 4.2开始，需要使用python3版本。</p>
<h3 id="pip"><a href="#pip" class="headerlink" title="pip"></a>pip</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 如果python没装pip，安装pip：</span></div><div class="line">wget https://bootstrap.pypa.io/get-pip.py --no-check-certificate</div><div class="line">python get-pip.py</div><div class="line"></div><div class="line"><span class="comment"># 安装当前版本</span></div><div class="line">pip install elasticsearch-curator</div><div class="line"></div><div class="line"><span class="comment"># 安装特定版本：</span></div><div class="line">pip install -U elasticsearch-curator==3.5.1</div><div class="line"></div><div class="line"><span class="comment"># 升级curator到最新新版本</span></div><div class="line">pip install -U elasticsearch-curator</div><div class="line"></div><div class="line"><span class="comment"># 升级curator到指定版本</span></div><div class="line">pip install -U elasticsearch-curator==3.5.1</div></pre></td></tr></table></figure>
<h3 id="APT-repository"><a href="#APT-repository" class="headerlink" title="APT repository"></a>APT repository</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget -qO - https://packages.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -</div><div class="line"><span class="built_in">echo</span> <span class="string">'deb http://packages.elastic.co/curator/4/debian stable main'</span> &gt; /etc/apt/sources.list.d/curator.list</div><div class="line">sudo apt-get update &amp;&amp; sudo apt-get install elasticsearch-curator</div></pre></td></tr></table></figure>
<h3 id="YUM-repository"><a href="#YUM-repository" class="headerlink" title="YUM repository"></a>YUM repository</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 添加Elastic' Signing Key：</span></div><div class="line">rpm --import https://packages.elastic.co/GPG-KEY-elasticsearch</div><div class="line"></div><div class="line"><span class="comment"># RHEL/CentOS 6: 写/etc/yum.repos.d/curator.repo</span></div><div class="line">[curator-4]</div><div class="line">name=CentOS/RHEL 6 repository <span class="keyword">for</span> Elasticsearch Curator 4.x packages</div><div class="line">baseurl=http://packages.elastic.co/curator/4/centos/6</div><div class="line">gpgcheck=1</div><div class="line">gpgkey=http://packages.elastic.co/GPG-KEY-elasticsearch</div><div class="line">enabled=1</div><div class="line"></div><div class="line"><span class="comment"># RHEL/CentOS 7: 写/etc/yum.repos.d/curator.repo</span></div><div class="line">[curator-4]</div><div class="line">name=CentOS/RHEL 7 repository <span class="keyword">for</span> Elasticsearch Curator 4.x packages</div><div class="line">baseurl=http://packages.elastic.co/curator/4/centos/7</div><div class="line">gpgcheck=1</div><div class="line">gpgkey=http://packages.elastic.co/GPG-KEY-elasticsearch</div><div class="line">enabled=1</div><div class="line"></div><div class="line">yum install elasticsearch-curator</div></pre></td></tr></table></figure>
<h3 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h3><p><a href="https://www.elastic.co/guide/en/elasticsearch/client/curator/current/python-source.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/client/curator/current/python-source.html</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">wget https://pypi.python.org/packages/<span class="built_in">source</span>/p/package/package-<span class="comment">#.#.#.tar.gz</span></div><div class="line">tar zxf package-<span class="comment">#.#.#.tar.gz</span></div><div class="line"><span class="built_in">cd</span> package-<span class="comment">#.#.#</span></div><div class="line">python setup.py install</div></pre></td></tr></table></figure>
<h2 id="Curator-Commands"><a href="#Curator-Commands" class="headerlink" title="Curator Commands"></a>Curator Commands</h2><ul>
<li>curator</li>
<li>curator_cli</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://vastxiao.github.io/elastic/curator_install/" data-id="cj0quu8vy00006196dmldrrqg" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/curator/">curator</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/elastic/">elastic</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/安装/">安装</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-curator_running" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/elastic/curator_running/" class="article-date">
  <time datetime="2017-03-26T11:17:02.000Z" itemprop="datePublished">2017-03-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/elastic/">elastic</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/elastic/curator_running/">Elastic Curator 的配置和运行</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h1 id="Elastic-Curator-的配置和运行"><a href="#Elastic-Curator-的配置和运行" class="headerlink" title="Elastic Curator 的配置和运行"></a>Elastic Curator 的配置和运行</h1><p>elasticsearch索引的管理工具curator4的配置和运行详解,这个是elastic官方提供的工具.</p>
<h2 id="Singleton-Command-Line-Interface"><a href="#Singleton-Command-Line-Interface" class="headerlink" title="Singleton Command Line Interface"></a>Singleton Command Line Interface</h2><p>运行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">curator_cli [OPTIONS] COMMAND [ARGS]...</div><div class="line"><span class="comment"># 如果用不指定的Options连接es，可以指定curator.yml配置文件读取连接es和curator的参数</span></div><div class="line"><span class="comment"># 默认配置文件~/.curator/curator.yml</span></div><div class="line">curator_cli --config /PATH/TO/curator.yml COMMAND [ARGS]...</div><div class="line"></div><div class="line"><span class="comment"># 帮助命令</span></div><div class="line">curator_cli --help</div><div class="line">curator_cli show_indices --help</div><div class="line"></div><div class="line"><span class="comment"># 例子</span></div><div class="line">curator_cli --host 192.168.1.36:9200 show_indices</div></pre></td></tr></table></figure>
<p>新版的curator_cli命令行工具对条件的匹配已经改了，<br>需要使用–filter_list JSON 的格式来过滤。(感觉已经没帮助可查了,用起来变得复杂- -！)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 例如查看索引，需要使用--filter_list来过滤需要的索引</span></div><div class="line">curator_cli --host 192.168.13.36:9200 show_indices  --filter_list <span class="string">'[&#123;"filtertype":"age","source":"creation_date","direction":"older","unit":"days","unit_count":13&#125;,&#123;"filtertype":"pattern","kind":"prefix","value":"logstash"&#125;]'</span></div></pre></td></tr></table></figure>
<p>这样还不如就用这个了：<br>curator [–config CONFIG.YML] [–dry-run] ACTION_FILE.YML</p>
<h2 id="Command-Line-Interface"><a href="#Command-Line-Interface" class="headerlink" title="Command Line Interface"></a>Command Line Interface</h2><p>运行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">curator [--config CONFIG.YML] [--dry-run] ACTION_FILE.YML</div><div class="line"></div><div class="line">  --config CONFIG.YML    curator配置文件，配置连接es等参数，</div><div class="line">                         默认为~/.curator/curator.yml</div><div class="line">  --dry-run              测试运行</div><div class="line">  ACTION_FILE.YML        YAML actionfile指定执行操作的文件</div></pre></td></tr></table></figure>
<h3 id="ACTION-FILE-YML"><a href="#ACTION-FILE-YML" class="headerlink" title="ACTION_FILE.YML"></a>ACTION_FILE.YML</h3><p>ACTION_FILE.YML文件用于配置curator需要执行的操作。</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/client/curator/current/actionfile.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/client/curator/current/actionfile.html</a></p>
<h4 id="curator-actions-cron-yml"><a href="#curator-actions-cron-yml" class="headerlink" title="curator_actions_cron.yml"></a>curator_actions_cron.yml</h4><p>主要用于配置curator定时执行任务，<br>将运行命令放在crontab中在每日凌晨0点过后执行，<br>用于清理和优化es的索引。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div></pre></td><td class="code"><pre><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">actions:</span></div><div class="line">  <span class="number">1</span><span class="string">:</span></div><div class="line"><span class="attr">    action:</span> <span class="string">delete_indices</span></div><div class="line"><span class="attr">    description:</span> <span class="string">"删除过期索引"</span></div><div class="line"><span class="attr">    options:</span></div><div class="line">      <span class="comment"># action开关，为True表示不执行这个action，默认False</span></div><div class="line"><span class="attr">      disable_action:</span> <span class="literal">False</span></div><div class="line">      <span class="comment"># 如果为True，则在filters空列表时，继续下一个action处理而不是退出程序。</span></div><div class="line"><span class="attr">      ignore_empty_list:</span> <span class="literal">True</span></div><div class="line">      <span class="comment"># 发现错误后，继续执行下一个索引操作，默认False</span></div><div class="line"><span class="attr">      continue_if_exception:</span> <span class="literal">True</span></div><div class="line"><span class="attr">    filters:</span></div><div class="line">    <span class="comment"># 是否排除隐藏索引，如.kibana</span></div><div class="line"><span class="attr">    - filtertype:</span> <span class="string">kibana</span></div><div class="line"><span class="attr">      exclude:</span> <span class="literal">True</span></div><div class="line">    <span class="comment"># 是否排除open状态的索引</span></div><div class="line"><span class="attr">    - filtertype:</span> <span class="string">opened</span></div><div class="line"><span class="attr">      exclude:</span> <span class="literal">True</span></div><div class="line">    <span class="comment"># 处理30天前的索引</span></div><div class="line"><span class="attr">    - filtertype:</span> <span class="string">age</span></div><div class="line"><span class="attr">      source:</span> <span class="string">name</span></div><div class="line"><span class="attr">      direction:</span> <span class="string">older</span></div><div class="line"><span class="attr">      timestring:</span> <span class="string">'%Y.%m.%d'</span></div><div class="line"><span class="attr">      unit:</span> <span class="string">days</span></div><div class="line"><span class="attr">      unit_count:</span> <span class="number">30</span></div><div class="line"><span class="attr">      exclude:</span> <span class="literal">False</span></div><div class="line">  <span class="number">2</span><span class="string">:</span></div><div class="line"><span class="attr">    action:</span> <span class="string">allocation</span></div><div class="line"><span class="attr">    description:</span> <span class="string">"冷热数据分离任务：将非当天索引从hot节点迁移到stale节点。"</span></div><div class="line"><span class="attr">    options:</span></div><div class="line">      <span class="comment"># action开关，为True表示不执行这个action，默认False</span></div><div class="line"><span class="attr">      disable_action:</span> <span class="literal">False</span></div><div class="line">      <span class="comment"># ignore_empty_list标识忽略选项，默认False，</span></div><div class="line">      <span class="comment"># 如果为True，则在filters空列表时，继续下一个action处理而不是退出程序。</span></div><div class="line"><span class="attr">      ignore_empty_list:</span> <span class="literal">True</span></div><div class="line">      <span class="comment"># 发现错误后，继续执行下一个索引操作，默认False</span></div><div class="line"><span class="attr">      continue_if_exception:</span> <span class="literal">True</span></div><div class="line"><span class="attr">      allocation_type:</span> <span class="string">include</span></div><div class="line"><span class="attr">      key:</span> <span class="string">zone</span></div><div class="line"><span class="attr">      value:</span> <span class="string">stale</span></div><div class="line"><span class="attr">      wait_for_completion:</span> <span class="literal">False</span></div><div class="line"><span class="attr">    filters:</span></div><div class="line">    <span class="comment"># 是否排除隐藏索引，如.kibana</span></div><div class="line"><span class="attr">    - filtertype:</span> <span class="string">kibana</span></div><div class="line"><span class="attr">      exclude:</span> <span class="literal">True</span></div><div class="line">    <span class="comment"># 是否排除open状态的索引</span></div><div class="line"><span class="attr">    - filtertype:</span> <span class="string">opened</span></div><div class="line"><span class="attr">      exclude:</span> <span class="literal">False</span></div><div class="line">    <span class="comment"># 处理1天前的索引</span></div><div class="line"><span class="attr">    - filtertype:</span> <span class="string">age</span></div><div class="line"><span class="attr">      source:</span> <span class="string">name</span></div><div class="line"><span class="attr">      direction:</span> <span class="string">older</span></div><div class="line"><span class="attr">      timestring:</span> <span class="string">'%Y.%m.%d'</span></div><div class="line"><span class="attr">      unit:</span> <span class="string">days</span></div><div class="line"><span class="attr">      unit_count:</span> <span class="number">1</span></div><div class="line"><span class="attr">      exclude:</span> <span class="literal">False</span></div><div class="line">  <span class="number">3</span><span class="string">:</span></div><div class="line"><span class="attr">    action:</span> <span class="string">forcemerge</span></div><div class="line"><span class="attr">    description:</span> <span class="string">"强制归并索引segments，优化es性能"</span></div><div class="line"><span class="attr">    options:</span></div><div class="line">      <span class="comment"># action开关，为True表示不执行这个action，默认False</span></div><div class="line"><span class="attr">      disable_action:</span> <span class="literal">False</span></div><div class="line">      <span class="comment"># ignore_empty_list标识忽略选项，默认False，</span></div><div class="line">      <span class="comment"># 如果为True，则在filters空列表时，继续下一个action处理而不是退出程序。</span></div><div class="line"><span class="attr">      ignore_empty_list:</span> <span class="literal">True</span></div><div class="line">      <span class="comment"># 发现错误后，继续执行下一个索引操作，默认False</span></div><div class="line"><span class="attr">      continue_if_exception:</span> <span class="literal">True</span></div><div class="line"><span class="attr">      max_num_segments:</span> <span class="number">1</span></div><div class="line"><span class="attr">      delay:</span></div><div class="line"><span class="attr">    filters:</span></div><div class="line">    <span class="comment"># 是否排除隐藏索引，如.kibana</span></div><div class="line"><span class="attr">    - filtertype:</span> <span class="string">kibana</span></div><div class="line"><span class="attr">      exclude:</span> <span class="literal">False</span></div><div class="line">    <span class="comment"># 是否排除open状态的索引</span></div><div class="line"><span class="attr">    - filtertype:</span> <span class="string">opened</span></div><div class="line"><span class="attr">      exclude:</span> <span class="literal">False</span></div><div class="line">    <span class="comment"># 处理1天前的索引</span></div><div class="line"><span class="attr">    - filtertype:</span> <span class="string">age</span></div><div class="line"><span class="attr">      source:</span> <span class="string">name</span></div><div class="line"><span class="attr">      direction:</span> <span class="string">older</span></div><div class="line"><span class="attr">      timestring:</span> <span class="string">'%Y.%m.%d'</span></div><div class="line"><span class="attr">      unit:</span> <span class="string">days</span></div><div class="line"><span class="attr">      unit_count:</span> <span class="number">2</span></div><div class="line"><span class="attr">      exclude:</span> <span class="literal">False</span></div><div class="line">  <span class="number">4</span><span class="string">:</span></div><div class="line"><span class="attr">    action:</span> <span class="string">close</span></div><div class="line"><span class="attr">    description:</span> <span class="string">"关闭匹配的索引，减少es内存占用"</span></div><div class="line"><span class="attr">    options:</span></div><div class="line">      <span class="comment"># action开关，为True表示不执行这个action，默认False</span></div><div class="line"><span class="attr">      disable_action:</span> <span class="literal">False</span></div><div class="line">      <span class="comment"># 如果为True，则在filters空列表时，继续下一个action处理而不是退出程序。</span></div><div class="line"><span class="attr">      ignore_empty_list:</span> <span class="literal">True</span></div><div class="line">      <span class="comment"># 发现错误后，继续执行下一个索引操作，默认False</span></div><div class="line"><span class="attr">      continue_if_exception:</span> <span class="literal">True</span></div><div class="line">      <span class="comment"># close索引前是否删除aliases</span></div><div class="line"><span class="attr">      delete_aliases:</span> <span class="literal">False</span></div><div class="line"><span class="attr">    filters:</span></div><div class="line">    <span class="comment"># 是否排除隐藏索引，如.kibana</span></div><div class="line"><span class="attr">    - filtertype:</span> <span class="string">kibana</span></div><div class="line"><span class="attr">      exclude:</span> <span class="literal">True</span></div><div class="line">    <span class="comment"># 是否排除open状态的索引</span></div><div class="line"><span class="attr">    - filtertype:</span> <span class="string">opened</span></div><div class="line"><span class="attr">      exclude:</span> <span class="literal">False</span></div><div class="line">    <span class="comment"># 处理7天前的索引</span></div><div class="line"><span class="attr">    - filtertype:</span> <span class="string">age</span></div><div class="line"><span class="attr">      source:</span> <span class="string">name</span></div><div class="line"><span class="attr">      direction:</span> <span class="string">older</span></div><div class="line"><span class="attr">      timestring:</span> <span class="string">'%Y.%m.%d'</span></div><div class="line"><span class="attr">      unit:</span> <span class="string">days</span></div><div class="line"><span class="attr">      unit_count:</span> <span class="number">7</span></div><div class="line"><span class="attr">      exclude:</span> <span class="literal">False</span></div></pre></td></tr></table></figure>
<h4 id="curator-actions-cmd-yml"><a href="#curator-actions-cmd-yml" class="headerlink" title="curator_actions_cmd.yml"></a>curator_actions_cmd.yml</h4><p>主要用于需要手动处理的es索引任务。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">actions:</span></div><div class="line">  <span class="number">1</span><span class="string">:</span></div><div class="line"><span class="attr">    action:</span> <span class="string">open</span></div><div class="line"><span class="attr">    description:</span> <span class="string">"open匹配的索引"</span></div><div class="line"><span class="attr">    options:</span></div><div class="line">      <span class="comment"># action开关，为True表示不执行这个action，默认False 【记得手动开启action】</span></div><div class="line"><span class="attr">      disable_action:</span> <span class="literal">True</span></div><div class="line">      <span class="comment"># 如果为True，则在filters空列表时，继续下一个action处理而不是退出程序。</span></div><div class="line"><span class="attr">      ignore_empty_list:</span> <span class="literal">True</span></div><div class="line">      <span class="comment"># 发现错误后，继续执行下一个索引操作，默认False</span></div><div class="line"><span class="attr">      continue_if_exception:</span> <span class="literal">True</span></div><div class="line">    <span class="comment"># 下面开始匹配需要执行的任务的索引 【记得手动修改filters条件】</span></div><div class="line"><span class="attr">    filters:</span></div><div class="line"><span class="attr">    - filtertype:</span> <span class="string">closed</span></div><div class="line"><span class="attr">      exclude:</span> <span class="literal">False</span></div><div class="line">    <span class="comment"># 是否排除open状态的索引</span></div><div class="line"><span class="attr">    - filtertype:</span> <span class="string">opened</span></div><div class="line"><span class="attr">      exclude:</span> <span class="literal">True</span></div><div class="line">    <span class="comment"># 是否排除隐藏索引，如.kibana</span></div><div class="line"><span class="attr">    - filtertype:</span> <span class="string">kibana</span></div><div class="line"><span class="attr">      exclude:</span> <span class="literal">True</span></div><div class="line">    <span class="comment"># 主要在这里匹配索引的时间</span></div><div class="line"><span class="attr">    - filtertype:</span> <span class="string">age</span></div><div class="line"><span class="attr">      source:</span> <span class="string">name</span></div><div class="line">      <span class="comment"># direction值为: younger|older</span></div><div class="line"><span class="attr">      direction:</span> <span class="string">younger</span></div><div class="line"><span class="attr">      timestring:</span> <span class="string">'%Y.%m.%d'</span></div><div class="line"><span class="attr">      unit:</span> <span class="string">days</span></div><div class="line"><span class="attr">      unit_count:</span> <span class="number">14</span></div><div class="line"><span class="attr">      exclude:</span> <span class="literal">False</span></div><div class="line">    <span class="comment"># 这里匹配索引名称</span></div><div class="line"><span class="attr">    - filtertype:</span> <span class="string">pattern</span></div><div class="line">      <span class="comment"># kind值: prefix|suffix|timestring|regex</span></div><div class="line"><span class="attr">      kind:</span> <span class="string">prefix</span></div><div class="line"><span class="attr">      value:</span> <span class="string">logstash-</span></div><div class="line"><span class="attr">      exclude:</span> <span class="literal">False</span></div></pre></td></tr></table></figure>
<h2 id="Environment-Variables"><a href="#Environment-Variables" class="headerlink" title="Environment Variables"></a>Environment Variables</h2><p>环境变量可以应用与执行curator和curator_cli命令。</p>
<p>环境变量支持写入CONFIG.YML和ACTION_FILE.YML。</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/client/curator/current/envvars.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/client/curator/current/envvars.html</a></p>
<h2 id="CONFIG-YML"><a href="#CONFIG-YML" class="headerlink" title="CONFIG.YML"></a>CONFIG.YML</h2><p><a href="https://www.elastic.co/guide/en/elasticsearch/client/curator/current/configfile.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/client/curator/current/configfile.html</a></p>
<p>CONFIG.YML是curator和curator_cli的全局配置文件。</p>
<p>在使用命令时，如果不指定配置文件，默认读取文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~/.curator/curator.yml</div></pre></td></tr></table></figure>
<p>curator.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">---</span></div><div class="line"><span class="comment"># Remember, leave a key empty if there is no value.  None will be a string,</span></div><div class="line"><span class="comment"># not a Python "NoneType"</span></div><div class="line"><span class="attr">client:</span></div><div class="line"><span class="attr">  hosts:</span></div><div class="line"><span class="bullet">    -</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.1</span></div><div class="line"><span class="bullet">    -</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.2</span><span class="string">:9200</span></div><div class="line"><span class="bullet">    -</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.3</span><span class="string">:9201</span></div><div class="line"><span class="attr">  port:</span> <span class="number">9200</span></div><div class="line"><span class="attr">  url_prefix:</span></div><div class="line"><span class="attr">  use_ssl:</span> <span class="literal">False</span></div><div class="line"><span class="attr">  certificate:</span></div><div class="line"><span class="attr">  client_cert:</span></div><div class="line"><span class="attr">  client_key:</span></div><div class="line"><span class="attr">  ssl_no_validate:</span> <span class="literal">False</span></div><div class="line"><span class="attr">  http_auth:</span></div><div class="line"><span class="attr">  timeout:</span> <span class="number">30</span></div><div class="line"><span class="attr">  master_only:</span> <span class="literal">False</span></div><div class="line"></div><div class="line"><span class="attr">logging:</span></div><div class="line"><span class="attr">  loglevel:</span> <span class="string">INFO</span></div><div class="line"><span class="attr">  logfile:</span></div><div class="line"><span class="attr">  logformat:</span> <span class="string">default</span></div><div class="line"><span class="attr">  blacklist:</span> <span class="string">['elasticsearch',</span> <span class="string">'urllib3'</span><span class="string">]</span></div></pre></td></tr></table></figure>
<h2 id="curator4版本当前的坑说明"><a href="#curator4版本当前的坑说明" class="headerlink" title="curator4版本当前的坑说明"></a>curator4版本当前的坑说明</h2><p>curator当前在filters中的age类型中对时间存在时差问题.</p>
<p>原因是,这个age对时间的计算形式如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">point_of_reference = epoch - ((number of seconds in unit) * unit_count)</div><div class="line"></div><div class="line">&lt;point_of_reference&gt;就是计算出来的时间</div><div class="line">&lt;epoch&gt;是当前时间的utc时间</div><div class="line">&lt;number of seconds in unit&gt;就是配置的day或hours单位的秒数,就是配置的unit换算来的.</div><div class="line">&lt;unit_count&gt;就是unit_count值</div><div class="line"></div><div class="line">curator直接是把&lt;point_of_reference&gt;这个时间拿来匹配索引的时间,比如索引名称的后缀时间%Y.%m.%d</div><div class="line"></div><div class="line">由这里很明显的知道了由于&lt;epoch&gt;是utc时间,所以&lt;point_of_reference&gt;也utc时间.</div><div class="line">那么,中国的和utc时间是要+8小时的,所以这里匹配出来的时间要再加8小时间才是对的.</div><div class="line"></div><div class="line">当前看似官方也知道这个问题,后面的版本可能会再换算一个native时区的时间吧.</div><div class="line"></div><div class="line">当前可以这样解决:</div><div class="line">在换算时间的时候,有意识的先扣掉8个小时再换算,这样就可以解决问题了:</div><div class="line"></div><div class="line">比如要获取前一天是索引,改成这样:</div><div class="line">    - filtertype: age</div><div class="line">      source: name</div><div class="line">      direction: older</div><div class="line">      timestring: &apos;%Y.%m.%d&apos;</div><div class="line">      unit: hours</div><div class="line">      unit_count: 16</div><div class="line">      exclude: False</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://vastxiao.github.io/elastic/curator_running/" data-id="cj0quu8w800016196g41ec5e4" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/curator/">curator</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/elastic/">elastic</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/配置/">配置</a></li></ul>

    </footer>
  </div>
  
</article>



  

</section>
           
    <aside id="sidebar">
  
    
  <div class="widget-wrap">
     
        <h3 class="follow-title ">Follow me</h3>
     
    <div class="widget follow">
     
     
            <a class="github" aria-hidden="true" href="https://github.com/Vastxiao" target="_blank" title="Github"></a>
    
     
     
     
    </div>
  </div>


  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title categories">Categories</h3>
    <div class="widget" id="categories">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/elastic/">elastic</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title tagcloud">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/curator/" style="font-size: 25px;">curator</a> <a href="/tags/elastic/" style="font-size: 25px;">elastic</a> <a href="/tags/安装/" style="font-size: 14px;">安装</a> <a href="/tags/配置/" style="font-size: 14px;">配置</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title recent-posts">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/elastic/curator_install/">Elastic Curator 简介和安装</a>
          </li>
        
          <li>
            <a href="/elastic/curator_running/">Elastic Curator 的配置和运行</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title archive">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>


  
</aside>

      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-left">
      &copy; 2014 - 2017 太渺小&nbsp;|&nbsp;
      Theme by <a href="https://github.com/giscafer/hexo-theme-cafe/" target="_blank">Cafe</a>
    </div>
     <div id="footer-right">
      Contact&nbsp;|&nbsp;https://vastxiao.github.io
    </div>
  </div>
</footer>
 <script src="/jquery/jquery.min.js"></script>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    <img class="back-to-top-btn" src="/images/fly-to-top.png"/>
<script>
// Elevator script included on the page, already.
window.onload = function() {
  var elevator = new Elevator({
    selector:'.back-to-top-btn',
    element: document.querySelector('.back-to-top-btn'),
    duration: 1000 // milliseconds
  });
}
</script>
    



 <script src="/js/is.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/elevator.js"></script>
  </div>
</body>
</html>